// This Pine Scriptâ„¢ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© fluxchart & Enhanced by Antigravity (NEXUS AI - BLOOMBERG EDITION)

//@version=5
strategy("NEXUS AI: Bloomberg Terminal [Ultimate]", overlay = true, max_boxes_count = 500, max_labels_count = 500, max_lines_count = 500, max_bars_back = 5000, initial_capital = 10000, default_qty_type = strategy.percent_of_equity, default_qty_value = 10, currency = currency.USD)

// =============================================================================
// 1. CONFIGURATION (CONTROL PANEL)
// =============================================================================
grp_eng = "âš™ï¸ ENGINE CONFIGURATION"
use_trend   = input.bool(true, "Trend Engine (MA + Cloud)", group = grp_eng)
use_mom     = input.bool(true, "Momentum Engine (RSI + BB)", group = grp_eng)
use_vol     = input.bool(true, "Volatility Engine (UT Bot + ATR)", group = grp_eng)
use_smc     = input.bool(true, "Smart Money Engine (OB + FVG)", group = grp_eng)

grp_vis = "ðŸ–¥ï¸ TERMINAL DISPLAY"
show_dash   = input.bool(true, "Show Bloomberg Dashboard", group = grp_vis)
dash_pos    = input.string("Bottom Right", "Position", options = ["Top Right", "Bottom Right", "Bottom Left"], group = grp_vis)
show_lines  = input.bool(true, "Show Projection Lines", group = grp_vis)

// =============================================================================
// 2. THE ANALYTIC ENGINES (THE BRAIN)
// =============================================================================

// --- A. TREND ENGINE (Identifying the 'River') ---
// Uses EMA 200 for long term, EMA 50 for mid term, and Parabolic SAR for short term.
ema_200 = ta.ema(close, 200)
ema_50  = ta.ema(close, 50)
sar     = ta.sar(0.02, 0.02, 0.2)

trend_score = 0
if close > ema_200 
    trend_score += 1
if close > ema_50 
    trend_score += 1
if close > sar 
    trend_score += 1

is_bull_trend = trend_score >= 2
is_bear_trend = trend_score <= 1 // Inverted for sells

// --- B. MOMENTUM ENGINE (Identifying the 'Speed') ---
// Uses RSI and Bollinger Bands Squeeze
rsi = ta.rsi(close, 14)
[bb_mid, bb_upper, bb_lower] = ta.bb(close, 20, 2)

mom_score = 0
if rsi > 50 
    mom_score += 1
if close > bb_mid 
    mom_score += 1

is_bull_mom = mom_score >= 2
is_bear_mom = mom_score <= 0

// --- C. VOLATILITY ENGINE (Identifying the 'Breakout') ---
// Uses UT Bot Logic (ATR Trailing)
a = input.int(1, "UT Key Value", group = grp_eng)
c = input.int(10, "UT ATR Period", group = grp_eng)
xATR = ta.atr(c)
nLoss = a * xATR
src = close

xATRTrailingStop = 0.0
xATRTrailingStop := if src > nz(xATRTrailingStop[1], 0) and src[1] > nz(xATRTrailingStop[1], 0)
    math.max(nz(xATRTrailingStop[1]), src - nLoss)
else if src < nz(xATRTrailingStop[1], 0) and src[1] < nz(xATRTrailingStop[1], 0)
    math.min(nz(xATRTrailingStop[1]), src + nLoss)
else 
    if src > nz(xATRTrailingStop[1], 0) 
        src - nLoss 
    else 
        src + nLoss

pos = 0   
pos := if src[1] < nz(xATRTrailingStop[1], 0) and src > nz(xATRTrailingStop[1], 0)
    1
else if src[1] > nz(xATRTrailingStop[1], 0) and src < nz(xATRTrailingStop[1], 0)
    -1
else 
    nz(pos[1], 0)

is_ut_buy = pos == 1 and pos[1] == -1
is_ut_sell = pos == -1 and pos[1] == 1

// --- D. SMART MONEY ENGINE (Identifying the 'Whales') ---
// 1. FVG (Fair Value Gap)
is_bull_fvg = low > high[2]
is_bear_fvg = high < low[2]

// 2. Market Structure (BOS - Break of Structure)
ph = ta.pivothigh(high, 5, 5)
pl = ta.pivotlow(low, 5, 5)
var float last_ph = na
var float last_pl = na

if not na(ph)
    last_ph := ph
if not na(pl)
    last_pl := pl

bos_bull = ta.crossover(close, last_ph) // Breakout Up
bos_bear = ta.crossunder(close, last_pl) // Breakout Down

// =============================================================================
// 3. THE NEXUS VOTING SYSTEM (CONFLUENCE)
// =============================================================================
// Use a weighted score to determine entry.
// Max Score = 100. Threshold = 80 (Super Ultra Precision).

var float total_score = 0.0

// Reset score
score_bull = 0.0
score_bear = 0.0

// 1. Trend (Weight: 30%)
if is_bull_trend 
    score_bull += 30
else 
    score_bear += 30

// 2. Momentum (Weight: 20%)
if is_bull_mom
    score_bull += 20
if is_bear_mom
    score_bear += 20

// 3. Volatility (Weight: 20%)
// We check if price is above UT Trailing Stop
if close > xATRTrailingStop
    score_bull += 20
else
    score_bear += 20

// 4. Smart Money (Weight: 30%)
// If we just broke structure or filled an FVG
if bos_bull or is_bull_fvg
    score_bull += 30
if bos_bear or is_bear_fvg
    score_bear += 30

// ENTRY TRIGGERS
// Only enter if Score >= 80 (High Confidence)
buy_signal = score_bull >= 80
sell_signal = score_bear >= 80

// =============================================================================
// 4. PREDICTION MODULE (FUTURE TARGETS)
// =============================================================================
// Using Fibonacci Extensions based on last swing
var float proj_tp1 = na
var float proj_tp2 = na
var float proj_sl = na

if buy_signal
    swing_h = last_ph ? last_ph : high
    swing_l = last_pl ? last_pl : low
    diff = swing_h - swing_l
    proj_tp1 := close + diff * 0.618
    proj_tp2 := close + diff * 1.618
    proj_sl := swing_l

if sell_signal
    swing_h = last_ph ? last_ph : high
    swing_l = last_pl ? last_pl : low
    diff = swing_h - swing_l
    proj_tp1 := close - diff * 0.618
    proj_tp2 := close - diff * 1.618
    proj_sl := swing_h

// =============================================================================
// 5. EXECUTION
// =============================================================================
if buy_signal
    strategy.entry("LONG", strategy.long, comment = "NEXUS BUY")
    strategy.exit("TP/SL", "LONG", stop = proj_sl, limit = proj_tp2)

if sell_signal
    strategy.entry("SHORT", strategy.short, comment = "NEXUS SELL")
    strategy.exit("TP/SL", "SHORT", stop = proj_sl, limit = proj_tp2)

// =============================================================================
// 6. BLOOMBERG TERMINAL DASHBOARD
// =============================================================================
var table dash = table.new(dash_pos == "Top Right" ? position.top_right : dash_pos == "Bottom Right" ? position.bottom_right : position.bottom_left, 4, 6, bgcolor = #000000, border_width = 1, frame_color = #ffffff)

if show_dash and barstate.islast
    // -- HEADER --
    table.cell(dash, 0, 0, "NEXUS AI", text_color = #00FF00, text_size = size.normal, text_halign = text.align_left)
    table.cell(dash, 1, 0, "TERMINAL", text_color = #00FF00, text_size = size.normal, text_halign = text.align_right)
    table.merge_cells(dash, 0, 0, 3, 0)
    
    // -- ROW 1: MARKET CONTEXT --
    table.cell(dash, 0, 1, "TREND", text_color = color.gray, text_size = size.small)
    table.cell(dash, 1, 1, is_bull_trend ? "BULLISH" : "BEARISH", text_color = is_bull_trend ? color.green : color.red, text_size = size.small, bgcolor = color.new(color.gray, 90))
    
    table.cell(dash, 2, 1, "MOMENTUM", text_color = color.gray, text_size = size.small)
    table.cell(dash, 3, 1, rsi > 50 ? "STRONG" : "WEAK", text_color = rsi > 50 ? color.green : color.red, text_size = size.small, bgcolor = color.new(color.gray, 90))

    // -- ROW 2: SMART MONEY --
    table.cell(dash, 0, 2, "STRUCTURE", text_color = color.gray, text_size = size.small)
    table.cell(dash, 1, 2, close > last_ph ? "BREAKOUT" : close < last_pl ? "BREAKDOWN" : "RANGING", text_color = color.yellow, text_size = size.small)

    table.cell(dash, 2, 2, "VOLATILITY", text_color = color.gray, text_size = size.small)
    table.cell(dash, 3, 2, high - low > ta.atr(14) ? "HIGH" : "NORMAL", text_color = color.white, text_size = size.small)

    // -- ROW 3: SCORES --
    table.cell(dash, 0, 3, "BULL SCORE", text_color = color.gray, text_size = size.small)
    table.cell(dash, 1, 3, str.tostring(score_bull, "#"), text_color = score_bull > 50 ? color.green : color.gray, text_size = size.normal)

    table.cell(dash, 2, 3, "BEAR SCORE", text_color = color.gray, text_size = size.small)
    table.cell(dash, 3, 3, str.tostring(score_bear, "#"), text_color = score_bear > 50 ? color.red : color.gray, text_size = size.normal)

    // -- ROW 4: PREDICTION --
    pred_text = "NEUTRAL (WAIT)"
    pred_col = color.gray
    
    if score_bull >= 80
        pred_text := "STRONG BUY >>>"
        pred_col := color.green
    else if score_bear >= 80
        pred_text := "STRONG SELL <<<"
        pred_col := color.red
    
    table.cell(dash, 0, 4, "PREDICTION", text_color = color.gray, text_size = size.small)
    table.cell(dash, 1, 4, pred_text, text_color = color.black, bgcolor = pred_col, text_size = size.normal)
    table.merge_cells(dash, 1, 4, 3, 4)

    // -- ROW 5: TARGETS --
    target_msg = "TP: " + str.tostring(proj_tp1, format.mintick) + " | SL: " + str.tostring(proj_sl, format.mintick)
    table.cell(dash, 0, 5, target_msg, text_color = color.white, text_size = size.small)
    table.merge_cells(dash, 0, 5, 3, 5)

// =============================================================================
// 7. VISUALS
// =============================================================================
// Candles
barcolor(score_bull > 60 ? color.green : score_bear > 60 ? color.red : color.gray)

// Projection Lines
if show_lines and not na(proj_tp1)
    line.new(bar_index, proj_tp1, bar_index + 10, proj_tp1, color = color.green, style = line.style_dashed)
    line.new(bar_index, proj_sl, bar_index + 10, proj_sl, color = color.red, style = line.style_solid)
    label.new(bar_index + 10, proj_tp1, "Target", textcolor = color.green, style = label.style_none)

